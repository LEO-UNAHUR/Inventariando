name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write

    steps:
      # ========================================
      # 1. CHECKOUT Y SETUP
      # ========================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Setup Java (Android build)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # ========================================
      # 2. INSTALACIÃ“N DE DEPENDENCIAS
      # ========================================
      - name: Install dependencies
        run: npm ci

      # ========================================
      # 3. BUILD WEB
      # ========================================
      - name: Build web app
        run: npm run build

      - name: Verify dist directory
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Error: dist/ directory not found"
            exit 1
          fi
          echo "âœ… dist/ directory exists"
          ls -la dist/

      # ========================================
      # 4. CAPACITOR SYNC
      # ========================================
      - name: Fix Gradle permissions
        run: chmod +x ./android/gradlew

      - name: Sync Capacitor (android)
        run: npx cap sync android

      # ========================================
      # 5. CREAR BUILD.GRADLE PARA CORDOVA PLUGINS
      # ========================================
      - name: Create capacitor-cordova-android-plugins build.gradle
        run: |
          dir="android/capacitor-cordova-android-plugins"
          mkdir -p "$dir"
          
          echo "ðŸ“ Creando build.gradle para $dir"
          cat > "$dir/build.gradle" << 'EOF'
          apply plugin: 'com.android.library'
          
          android {
              namespace "com.getcapacitor.cordova.android.plugins"
              compileSdk rootProject.ext.compileSdkVersion
              
              defaultConfig {
                  minSdk rootProject.ext.minSdkVersion
                  targetSdk rootProject.ext.targetSdkVersion
              }
              
              buildTypes {
                  release {
                      minifyEnabled false
                  }
              }
              
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
          }
          
          dependencies {
              implementation fileTree(dir: 'src/main/libs', include: ['*.jar'])
          }
          EOF
          
          echo "ðŸ“ Creando cordova.variables.gradle para $dir"
          cat > "$dir/cordova.variables.gradle" << 'EOF'
          ext {
              cdvMinSdkVersion = project.hasProperty('minSdkVersion') ? rootProject.ext.minSdkVersion : 24
              cdvPluginPostBuildExtras = []
              cordovaConfig = [:]
          }
          EOF
          
          echo "âœ… Archivos creados en $dir"
          ls -la "$dir"

      # ========================================
      # 6. PREPARAR KEYSTORE
      # ========================================
      - name: Prepare keystore (from secret)
        id: keystore
        run: |
          if [ -z "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "âš ï¸  Warning: ANDROID_KEYSTORE_BASE64 secret not configured"
            echo "is_signed=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸ” Decoding keystore to android/release.keystore"
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/release.keystore
            
            # Verificar que el archivo existe y tiene contenido
            if [ ! -f "android/release.keystore" ]; then
              echo "âŒ Error: Keystore file not created"
              exit 1
            fi
            
            file_size=$(stat -f%z "android/release.keystore" 2>/dev/null || stat -c%s "android/release.keystore")
            if [ "$file_size" -eq 0 ]; then
              echo "âŒ Error: Keystore file is empty"
              exit 1
            fi
            
            echo "âœ… Keystore created successfully ($file_size bytes)"
            ls -lh android/release.keystore
            echo "is_signed=true" >> $GITHUB_OUTPUT
          fi

      # ========================================
      # 7. BUILD ANDROID APK
      # ========================================
      - name: Build Android Release APK
        working-directory: android
        run: |
          echo "ðŸ—ï¸  Starting Android build..."
          echo "Working directory: $(pwd)"
          echo "Gradle version:"
          ./gradlew --version
          
          if [ "${{ steps.keystore.outputs.is_signed }}" == "true" ]; then
            echo "ðŸ“¦ Building SIGNED release APK..."
            echo "Keystore location: $(pwd)/release.keystore"
            
            ./gradlew assembleRelease \
              -Pandroid.injected.signing.store.file=release.keystore \
              -Pandroid.injected.signing.store.password=${{ secrets.KEYSTORE_PASSWORD }} \
              -Pandroid.injected.signing.key.alias=${{ secrets.KEY_ALIAS }} \
              -Pandroid.injected.signing.key.password=${{ secrets.KEY_PASSWORD }} \
              --stacktrace
          else
            echo "ðŸ“¦ Building UNSIGNED debug APK..."
            ./gradlew assembleDebug --stacktrace
          fi
          
          echo "âœ… Build completed"

      - name: Verify APK was created
        run: |
          if [ "${{ steps.keystore.outputs.is_signed }}" == "true" ]; then
            apk_path="android/app/build/outputs/apk/release/app-release.apk"
          else
            apk_path="android/app/build/outputs/apk/debug/app-debug.apk"
          fi
          
          if [ ! -f "$apk_path" ]; then
            echo "âŒ Error: APK not found at $apk_path"
            exit 1
          fi
          
          echo "âœ… APK found at $apk_path"
          ls -lh "$apk_path"

      # ========================================
      # 8. RENOMBRAR APK
      # ========================================
      - name: Rename APK
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          if [ "${{ steps.keystore.outputs.is_signed }}" == "true" ]; then
            mv android/app/build/outputs/apk/release/app-release.apk \
               "inventariando-${VERSION}.apk"
            echo "apk_name=inventariando-${VERSION}.apk" >> $GITHUB_ENV
          else
            mv android/app/build/outputs/apk/debug/app-debug.apk \
               "inventariando-${VERSION}-debug.apk"
            echo "apk_name=inventariando-${VERSION}-debug.apk" >> $GITHUB_ENV
          fi
          
          echo "âœ… APK renamed to ${{ env.apk_name }}"
          ls -lh "${{ env.apk_name }}"

      # ========================================
      # 9. CREAR RELEASE EN GITHUB
      # ========================================
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            ## ðŸ“± Inventariando ${{ github.ref }}
            
            ### ðŸ“¥ Descargas
            - APK para Android disponible mÃ¡s abajo
            
            ### âœ¨ Novedades
            <!-- Agregar manualmente las novedades de esta versiÃ³n -->
            
            ### ðŸ”§ InformaciÃ³n TÃ©cnica
            - Build: ${{ github.run_number }}
            - Commit: ${{ github.sha }}
            - Firmado: ${{ steps.keystore.outputs.is_signed }}
            
            ---
            Generado automÃ¡ticamente por GitHub Actions
          draft: false
          prerelease: false

      - name: Upload APK to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./${{ env.apk_name }}
          asset_name: ${{ env.apk_name }}
          asset_content_type: application/vnd.android.package-archive

      # ========================================
      # 10. GENERAR DOCUMENTACIÃ“N (si existe)
      # ========================================
      - name: Generate TypeDoc documentation
        if: hashFiles('typedoc.json') != ''
        run: |
          if npm run docs --if-present; then
            echo "âœ… Documentation generated"
          else
            echo "âš ï¸  Documentation generation skipped or failed"
          fi

      - name: Deploy documentation to GitHub Pages
        if: hashFiles('typedoc.json') != '' && hashFiles('docs/') != ''
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages
          
      # ========================================
      # 11. LIMPIEZA
      # ========================================
      - name: Cleanup sensitive files
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up sensitive files..."
          rm -f android/release.keystore
          rm -f android/app/release.keystore
          echo "âœ… Cleanup completed"

      # ========================================
      # 12. RESUMEN
      # ========================================
      - name: Build Summary
        if: always()
        run: |
          echo "## ðŸ“Š Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Signed:** ${{ steps.keystore.outputs.is_signed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **APK:** `${{ env.apk_name }}`" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** `${{ github.sha }}`" >> $GITHUB_STEP_SUMMARY
