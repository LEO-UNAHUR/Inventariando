name: Release APK & Build

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Tipo de release (usado por el script local)'
        required: true
        default: 'beta'
        type: choice
        options:
          - beta
          - stable

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Permiso para crear y subir assets a un release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necesario para que actions/create-release encuentre el tag correcto

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Setup Java (Android build)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install dependencies
        run: npm ci

      - name: Fix Gradle permissions
        run: chmod +x ./android/gradlew

      - name: Sync Capacitor (android)
        run: npx cap sync android

      - name: Create capacitor-cordova-android-plugins build.gradle
        run: |
          dir="android/capacitor-cordova-android-plugins"
          mkdir -p "$dir"
          
          cat > "$dir/build.gradle" << 'EOF'
          apply plugin: 'com.android.library'
          
          android {
              namespace "com.getcapacitor.cordova.android.plugins"
              compileSdk rootProject.ext.compileSdkVersion
              
              defaultConfig {
                  minSdk rootProject.ext.minSdkVersion
                  targetSdk rootProject.ext.targetSdkVersion
              }
              
              buildTypes {
                  release {
                      minifyEnabled false
                  }
              }
              
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
          }
          
          dependencies {
              implementation fileTree(dir: 'src/main/libs', include: ['*.jar'])
          }
          EOF
          
          cat > "$dir/cordova.variables.gradle" << 'EOF'
          ext {
              cdvMinSdkVersion = project.hasProperty('minSdkVersion') ? rootProject.ext.minSdkVersion : 24
              cdvPluginPostBuildExtras = []
              cordovaConfig = [:]
          }
          EOF
          
          echo "Archivos creados en $dir"

      - name: Prepare keystore (from secret)
        id: prepare_keystore
        run: |
          if [ -z "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "::warning::El secreto ANDROID_KEYSTORE_BASE64 no está configurado. El APK no será firmado."
            echo "is_signed=false" >> $GITHUB_OUTPUT
          else
            echo "Keystore secret presente — decodificando a android/app/inventariando.keystore"
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/inventariando.keystore
            echo "is_signed=true" >> $GITHUB_OUTPUT
          fi

      - name: Ensure cordova variables file exists
        run: |
          dir=android/capacitor-cordova-android-plugins
          file="$dir/cordova.variables.gradle"
          if [ ! -f "$file" ]; then
            echo "Creando $file (generado por CI)"
            mkdir -p "$dir"
            # Contenido mínimo para que Gradle no falle
            echo "ext { cdvMinSdkVersion = project.hasProperty('minSdkVersion') ? rootProject.ext.minSdkVersion : 24; cdvPluginPostBuildExtras = []; cordovaConfig = [:] }" > "$file"
          fi

      - name: Build Android Release
        working-directory: android
        run: |
          if [ "${{ steps.prepare_keystore.outputs.is_signed }}" == "true" ]; then
            echo "Construyendo APK firmado..."
            ./gradlew assembleRelease \
              -Pandroid.injected.signing.store.file=app/inventariando.keystore \
              -Pandroid.injected.signing.store.password=${{ secrets.ANDROID_KEYSTORE_PASSWORD }} \
              -Pandroid.injected.signing.key.alias=${{ secrets.ANDROID_KEY_ALIAS }} \
              -Pandroid.injected.signing.key.password=${{ secrets.ANDROID_KEY_PASSWORD }}
          else
            echo "Construyendo APK de depuración (sin firmar)..."
            ./gradlew assembleDebug
          fi

      - name: Find built APK
        id: find_apk
        run: |
          # Prioriza el APK de release, si no, busca el de debug
          apk_path=$(find android/app/build/outputs/apk/release -name "*.apk" | head -n 1)
          if [ -z "$apk_path" ]; then
            apk_path=$(find android/app/build/outputs/apk/debug -name "*.apk" | head -n 1)
          fi
          if [ -z "$apk_path" ]; then
            echo "::error::No se encontró ningún APK generado."
            exit 1
          fi
          echo "apk_path=$apk_path" >> $GITHUB_OUTPUT
          echo "Found APK at $apk_path"

      - name: Read package.json version
        id: pkg
        run: echo "version=$(node -p \"require('./package.json').version\")" >> $GITHUB_OUTPUT

      - name: Create or Update GitHub Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: v${{ steps.pkg.outputs.version }}
          release_name: Release ${{ steps.pkg.outputs.version }}
          body: |
            Release automático para la versión ${{ steps.pkg.outputs.version }}.
            APK generado por GitHub Actions.
          draft: false
          prerelease: ${{ contains(steps.pkg.outputs.version, '-beta') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload APK to Release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.find_apk.outputs.apk_path }}
          asset_name: Inventariando-v${{ steps.pkg.outputs.version }}.apk
          asset_content_type: application/vnd.android.package-archive

      - name: Build PWA for GitHub Pages (stable only)
        if: github.event.inputs.release_type == 'stable'
        run: npm run build:web:pages

      - name: Deploy to GitHub Pages (stable only)
        if: github.event.inputs.release_type == 'stable'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: gh-pages
          force_orphan: true
