name: Release APK & Build

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Tipo de release'
        required: true
        default: 'beta'
        type: choice
        options:
          - beta
          - stable

jobs:
  release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      packages: write

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ðŸ”§ Setup Java (for Android build)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name:  Install dependencies
        run: npm ci

      - name: ðŸ”‘ Generate Android Keystore
        run: bash scripts/generate-keystore.sh

      - name: ðŸ” Fix Gradle Permissions
        run: chmod +x ./android/gradlew

      - name: ðŸªª Configure git identity
        run: |
          git config --global user.email "leonardo@inventariando.app"
          git config --global user.name "Leonardo Esteves"
          git config --global pull.rebase false
          git config --global init.defaultBranch main

      - name: ï¿½ Bump version
        run: npm run release:version
        env:
          RELEASE_TYPE: ${{ github.event.inputs.release_type }}

      - name: ðŸ“– Extract version
        id: extract_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: ðŸ“¦ Build Android & APK
        run: npm run release:build

      - name: ðŸ” Sign APK with jarsigner
        run: |
          APK_PATH="android/app/build/outputs/apk/release/app-release-unsigned.apk"
          SIGNED_APK_PATH="android/app/build/outputs/apk/release/app-release.apk"
          KEYSTORE_PATH="android/app/inventariando.keystore"
          
          if [ -f "$APK_PATH" ]; then
            echo "Signing APK..."
            jarsigner -verbose \
              -sigalg SHA256withRSA \
              -digestalg SHA256 \
              -keystore "$KEYSTORE_PATH" \
              -storepass inventariando2024 \
              -keypass inventariando2024 \
              "$APK_PATH" \
              inventariando
            
            if [ -f "$SIGNED_APK_PATH" ]; then
              echo "âœ… APK signed successfully"
            else
              echo "âŒ APK signing failed"
              exit 1
            fi
          else
            echo "âŒ Unsigned APK not found at $APK_PATH"
            exit 1
          fi

      - name: ðŸ” Commit changes
        run: |
          git config --local user.email "leonardo@inventariando.app"
          git config --local user.name "Leonardo Esteves"
          git add -A
          git commit -m "chore: Release v${{ steps.extract_version.outputs.version }}" || true

      - name: ðŸ“¤ Push changes
        run: |
          git push origin main --force-with-lease || true

      - name: ðŸ·ï¸ Create Git Tag
        run: |
          git tag -a "v${{ steps.extract_version.outputs.version }}" -m "Release v${{ steps.extract_version.outputs.version }}" || true
          git push origin "v${{ steps.extract_version.outputs.version }}" || true

      - name: ðŸ“¦ Create GitHub Release (API)
        run: |
          RELEASE_BODY="# ðŸš€ Inventariando v${{ steps.extract_version.outputs.version }}

          **Tipo de Release:** ${{ github.event.inputs.release_type }}

          ## ðŸ“ Cambios
          - Consulta el CHANGELOG.md para detalles completos
          - ActualizaciÃ³n automÃ¡tica mediante GitHub Actions

          ## ðŸ“¥ InstalaciÃ³n (Android)
          1. Descarga el archivo \`.apk\` desde este release
          2. En tu telÃ©fono, ve a ConfiguraciÃ³n > Seguridad > Permitir instalaciÃ³n de fuentes desconocidas
          3. Abre el archivo APK y sigue las instrucciones

          ## ðŸ”— Enlaces
          - [GitHub Repository](https://github.com/LEO-UNAHUR/Inventariando)
          - [DocumentaciÃ³n](https://github.com/LEO-UNAHUR/Inventariando/blob/main/README.md)

          ---
          *Build automÃ¡tico: ${{ github.run_id }}*"
          
          IS_PRERELEASE=$([[ "${{ github.event.inputs.release_type }}" == "beta" ]] && echo "true" || echo "false")
          
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"tag_name\": \"v${{ steps.extract_version.outputs.version }}\",
              \"target_commitish\": \"main\",
              \"name\": \"Inventariando v${{ steps.extract_version.outputs.version }}\",
              \"body\": $(echo \"$RELEASE_BODY\" | jq -Rs .),
              \"draft\": false,
              \"prerelease\": $IS_PRERELEASE
            }" \
            "https://api.github.com/repos/LEO-UNAHUR/Inventariando/releases"

      - name: ðŸ“¤ Upload APK asset
        run: |
          APK_PATH="APK/v${{ steps.extract_version.outputs.version }}/Inventariando-${{ steps.extract_version.outputs.version }}.apk"
          if [ ! -f "$APK_PATH" ]; then
            echo "APK no encontrado en $APK_PATH"
            exit 1
          fi
          gh release upload "v${{ steps.extract_version.outputs.version }}" "$APK_PATH" --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Build Summary
        run: |
          echo "âœ… Release completado exitosamente"
          echo "ðŸ”– Tag: v${{ steps.extract_version.outputs.version }}"
          echo "ðŸ“¦ APK disponible en: APK/v${{ steps.extract_version.outputs.version }}/"
          echo "ðŸ”— GitHub Release: https://github.com/LEO-UNAHUR/Inventariando/releases/tag/v${{ steps.extract_version.outputs.version }}"
